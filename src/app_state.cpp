#include "app.h"

namespace loader {

const COLORREF kBgTop = RGB(14, 15, 18);
const COLORREF kBgBottom = RGB(24, 26, 31);
const COLORREF kTitleTop = RGB(18, 20, 24);
const COLORREF kTitleBottom = RGB(30, 33, 40);
const COLORREF kFrameBorder = RGB(52, 58, 70);
const COLORREF kSurface = RGB(24, 28, 34);
const COLORREF kSurfaceAlt = RGB(30, 34, 41);
const COLORREF kSurfaceBorder = RGB(70, 78, 92);
const COLORREF kButtonHover = RGB(42, 48, 58);
const COLORREF kButtonPressed = RGB(34, 40, 50);
const COLORREF kRowEven = RGB(24, 28, 34);
const COLORREF kRowOdd = RGB(28, 32, 38);
const COLORREF kRowSelected = RGB(30, 44, 62);
const COLORREF kTextColor = RGB(232, 237, 244);
const COLORREF kAccentColor = RGB(89, 129, 235);
const COLORREF kAccentAlt = RGB(89, 129, 235);
const COLORREF kMutedColor = RGB(144, 154, 170);
const COLORREF kMaskColor = RGB(255, 0, 255);

const char kLoaderVersion[] = "1.2.2";
const wchar_t kDefaultServerUrl[] = L"tcps://45.8.145.200:4000";
const wchar_t kDefaultExpectedThumbprint[] = L"0219BB3E2098384C323E494FA285FC594993951A6822852764B163CBA7F273D2"; // Set to TLS cert thumbprint (hex) for pinning.
const wchar_t kDefaultUserAgent[] = L"u3ware/1.0";
const wchar_t kDefaultTargetProcess[] = L"wotblitz.exe";

namespace {
constexpr unsigned char kResponseKeyXor = 0x7E;
const unsigned char kEncryptedResponseKey[] = {
    0x53, 0x53, 0x53, 0x53, 0x53, 0x3C, 0x3B, 0x39, 0x37, 0x30, 0x5E, 0x2E, 0x2B, 0x3C, 0x32, 0x37,
    0x3D, 0x5E, 0x35, 0x3B, 0x27, 0x53, 0x53, 0x53, 0x53, 0x53, 0x74, 0x33, 0x37, 0x37, 0x3C, 0x37,
    0x14, 0x3F, 0x30, 0x3C, 0x19, 0x15, 0x0F, 0x16, 0x15, 0x17, 0x39, 0x47, 0x09, 0x4E, 0x3C, 0x3F,
    0x2F, 0x3B, 0x38, 0x3F, 0x3F, 0x31, 0x3D, 0x3F, 0x2F, 0x46, 0x3F, 0x33, 0x37, 0x37, 0x3C, 0x3D,
    0x19, 0x35, 0x3D, 0x3F, 0x2F, 0x3B, 0x3F, 0x47, 0x0C, 0x30, 0x33, 0x39, 0x2F, 0x31, 0x28, 0x29,
    0x4B, 0x12, 0x18, 0x36, 0x2A, 0x3A, 0x24, 0x13, 0x0B, 0x14, 0x35, 0x74, 0x16, 0x2B, 0x1C, 0x4D,
    0x11, 0x4E, 0x4A, 0x3C, 0x3C, 0x09, 0x51, 0x29, 0x12, 0x2F, 0x28, 0x04, 0x1C, 0x4A, 0x17, 0x0B,
    0x24, 0x46, 0x39, 0x3F, 0x06, 0x36, 0x0D, 0x2A, 0x10, 0x49, 0x2A, 0x12, 0x0E, 0x24, 0x3F, 0x4C,
    0x4A, 0x4F, 0x2A, 0x1A, 0x1A, 0x51, 0x51, 0x55, 0x24, 0x3B, 0x3C, 0x08, 0x3C, 0x28, 0x0C, 0x2B,
    0x12, 0x0F, 0x1A, 0x07, 0x32, 0x2E, 0x47, 0x30, 0x4E, 0x04, 0x4E, 0x47, 0x74, 0x10, 0x1C, 0x2D,
    0x15, 0x14, 0x32, 0x11, 0x12, 0x2C, 0x11, 0x1B, 0x1B, 0x07, 0x3F, 0x48, 0x0D, 0x4C, 0x3D, 0x35,
    0x0D, 0x15, 0x51, 0x34, 0x1B, 0x2F, 0x47, 0x4B, 0x4F, 0x12, 0x12, 0x2B, 0x3B, 0x31, 0x4F, 0x49,
    0x49, 0x2B, 0x14, 0x11, 0x4D, 0x1C, 0x04, 0x4F, 0x4E, 0x1D, 0x31, 0x1C, 0x38, 0x4C, 0x2C, 0x28,
    0x51, 0x2B, 0x1A, 0x4C, 0x0C, 0x13, 0x51, 0x0D, 0x2B, 0x3A, 0x3D, 0x48, 0x06, 0x74, 0x32, 0x2F,
    0x0C, 0x32, 0x31, 0x14, 0x2E, 0x09, 0x0F, 0x1C, 0x39, 0x16, 0x15, 0x0B, 0x47, 0x49, 0x30, 0x08,
    0x3F, 0x48, 0x14, 0x15, 0x1F, 0x34, 0x2E, 0x0C, 0x11, 0x34, 0x0E, 0x06, 0x3D, 0x17, 0x2A, 0x27,
    0x27, 0x2F, 0x34, 0x06, 0x0D, 0x18, 0x2D, 0x33, 0x0F, 0x10, 0x2A, 0x4D, 0x2C, 0x24, 0x08, 0x0F,
    0x3D, 0x38, 0x4F, 0x06, 0x0B, 0x13, 0x31, 0x1B, 0x3D, 0x0A, 0x26, 0x38, 0x35, 0x15, 0x74, 0x36,
    0x2B, 0x17, 0x2D, 0x3B, 0x19, 0x33, 0x0C, 0x06, 0x48, 0x10, 0x4D, 0x17, 0x06, 0x2F, 0x07, 0x3A,
    0x0A, 0x3F, 0x3B, 0x4C, 0x13, 0x3F, 0x28, 0x24, 0x4E, 0x1A, 0x31, 0x1A, 0x34, 0x11, 0x34, 0x47,
    0x37, 0x38, 0x14, 0x38, 0x0A, 0x19, 0x0B, 0x47, 0x0A, 0x48, 0x14, 0x2D, 0x1C, 0x17, 0x48, 0x4E,
    0x13, 0x33, 0x55, 0x4F, 0x33, 0x4B, 0x15, 0x2C, 0x4E, 0x55, 0x31, 0x11, 0x10, 0x28, 0x3D, 0x74,
    0x4E, 0x1C, 0x19, 0x4B, 0x19, 0x34, 0x3D, 0x46, 0x2B, 0x4E, 0x19, 0x34, 0x10, 0x1C, 0x47, 0x2D,
    0x35, 0x1D, 0x11, 0x2F, 0x4C, 0x1B, 0x38, 0x36, 0x3D, 0x15, 0x30, 0x13, 0x0D, 0x27, 0x3F, 0x39,
    0x55, 0x32, 0x06, 0x36, 0x34, 0x28, 0x11, 0x2D, 0x13, 0x51, 0x12, 0x36, 0x18, 0x1F, 0x0A, 0x46,
    0x3D, 0x0B, 0x29, 0x1F, 0x28, 0x3B, 0x32, 0x16, 0x3F, 0x24, 0x46, 0x4A, 0x1A, 0x3F, 0x1A, 0x0B,
    0x74, 0x26, 0x2F, 0x37, 0x3A, 0x3F, 0x2F, 0x3F, 0x3C, 0x74, 0x53, 0x53, 0x53, 0x53, 0x53, 0x3B,
    0x30, 0x3A, 0x5E, 0x2E, 0x2B, 0x3C, 0x32, 0x37, 0x3D, 0x5E, 0x35, 0x3B, 0x27, 0x53, 0x53, 0x53,
    0x53, 0x53, 0x74,
};
} // namespace

std::string GetResponsePublicKeyPem() {
    static std::string cached;
    if (!cached.empty()) {
        return cached;
    }
    cached.resize(sizeof(kEncryptedResponseKey));
    for (size_t i = 0; i < sizeof(kEncryptedResponseKey); ++i) {
        cached[i] = static_cast<char>(kEncryptedResponseKey[i] ^ kResponseKeyXor);
    }
    return cached;
}

HWND g_edit = nullptr;
HWND g_button = nullptr;
HWND g_status = nullptr;
HWND g_title = nullptr;
HWND g_subtitle = nullptr;
HWND g_label_key = nullptr;
HWND g_label_programs = nullptr;
HWND g_label_col_program = nullptr;
HWND g_label_col_updated = nullptr;
HWND g_label_col_expires = nullptr;
HWND g_list = nullptr;
HWND g_status_hwnd = nullptr;
HWND g_status_title = nullptr;
HWND g_status_overlay = nullptr;
HFONT g_title_font = nullptr;
HFONT g_subtitle_font = nullptr;
HFONT g_body_font = nullptr;
HFONT g_small_font = nullptr;
HFONT g_avatar_font = nullptr;
HIMAGELIST g_avatar_list = nullptr;
HBRUSH g_bg_brush = nullptr;
HBRUSH g_panel_brush = nullptr;
HBRUSH g_panel_alt_brush = nullptr;
Config g_config;
CRITICAL_SECTION g_status_lock;
std::wstring g_status_text;
CRITICAL_SECTION g_programs_lock;
std::vector<ProgramInfo> g_programs;
bool g_validated = false;
UINT g_dpi = 96;
RECT g_card_auth = {};
RECT g_card_programs = {};
RECT g_card_telemetry = {};
RECT g_table_header = {};
RECT g_field_key = {};
int g_products_scroll = 0;
int g_hover_product_index = -1;
POINT g_mouse_pos = {};
bool g_mouse_in_window = false;
std::string g_last_error_code;
bool g_keyboard_nav_active = false;
RECT g_btn_close = {};
RECT g_btn_min = {};
int g_titlebar_height = 0;
bool g_hover_close = false;
bool g_hover_min = false;
bool g_pressed_close = false;
bool g_pressed_min = false;
bool g_tracking_mouse = false;
UiStage g_stage = UiStage::Login;
std::wstring g_cached_key;
HWND g_hwnd = nullptr;
int g_selected_index = -1;
std::string g_event_token;

} // namespace loader

#include "app.h"

namespace loader {

const COLORREF kBgTop = RGB(8, 11, 18);
const COLORREF kBgBottom = RGB(16, 20, 30);
const COLORREF kTitleTop = RGB(12, 15, 22);
const COLORREF kTitleBottom = RGB(18, 22, 32);
const COLORREF kFrameBorder = RGB(30, 38, 52);
const COLORREF kSurface = RGB(22, 28, 40);
const COLORREF kSurfaceAlt = RGB(28, 36, 50);
const COLORREF kSurfaceBorder = RGB(46, 60, 82);
const COLORREF kButtonHover = RGB(34, 44, 60);
const COLORREF kButtonPressed = RGB(26, 34, 48);
const COLORREF kRowEven = RGB(22, 28, 40);
const COLORREF kRowOdd = RGB(26, 33, 46);
const COLORREF kRowSelected = RGB(38, 64, 86);
const COLORREF kTextColor = RGB(232, 236, 243);
const COLORREF kAccentColor = RGB(92, 234, 214);
const COLORREF kAccentAlt = RGB(90, 160, 255);
const COLORREF kMutedColor = RGB(148, 158, 172);
const COLORREF kMaskColor = RGB(255, 0, 255);

const char kLoaderVersion[] = "1.2.0";
const wchar_t kDefaultServerUrl[] = L"https://u3.llvm.uk";
const wchar_t kDefaultExpectedThumbprint[] = L"3BB5AD9A07C169E665AA8777EC428487032CC3D4";
const wchar_t kDefaultUserAgent[] = L"u3ware/1.0";
const wchar_t kDefaultTargetProcess[] = L"wotblitz.exe";

namespace {
constexpr unsigned char kResponseKeyXor = 0x7E;
const unsigned char kEncryptedResponseKey[] = {
    0x53, 0x53, 0x53, 0x53, 0x53, 0x3C, 0x3B, 0x39, 0x37, 0x30, 0x5E, 0x2E, 0x2B, 0x3C, 0x32, 0x37,
    0x3D, 0x5E, 0x35, 0x3B, 0x27, 0x53, 0x53, 0x53, 0x53, 0x53, 0x74, 0x33, 0x37, 0x37, 0x3C, 0x37,
    0x14, 0x3F, 0x30, 0x3C, 0x19, 0x15, 0x0F, 0x16, 0x15, 0x17, 0x39, 0x47, 0x09, 0x4E, 0x3C, 0x3F,
    0x2F, 0x3B, 0x38, 0x3F, 0x3F, 0x31, 0x3D, 0x3F, 0x2F, 0x46, 0x3F, 0x33, 0x37, 0x37, 0x3C, 0x3D,
    0x19, 0x35, 0x3D, 0x3F, 0x2F, 0x3B, 0x3F, 0x47, 0x0C, 0x30, 0x33, 0x39, 0x2F, 0x31, 0x28, 0x29,
    0x4B, 0x12, 0x18, 0x36, 0x2A, 0x3A, 0x24, 0x13, 0x0B, 0x14, 0x35, 0x74, 0x16, 0x2B, 0x1C, 0x4D,
    0x11, 0x4E, 0x4A, 0x3C, 0x3C, 0x09, 0x51, 0x29, 0x12, 0x2F, 0x28, 0x04, 0x1C, 0x4A, 0x17, 0x0B,
    0x24, 0x46, 0x39, 0x3F, 0x06, 0x36, 0x0D, 0x2A, 0x10, 0x49, 0x2A, 0x12, 0x0E, 0x24, 0x3F, 0x4C,
    0x4A, 0x4F, 0x2A, 0x1A, 0x1A, 0x51, 0x51, 0x55, 0x24, 0x3B, 0x3C, 0x08, 0x3C, 0x28, 0x0C, 0x2B,
    0x12, 0x0F, 0x1A, 0x07, 0x32, 0x2E, 0x47, 0x30, 0x4E, 0x04, 0x4E, 0x47, 0x74, 0x10, 0x1C, 0x2D,
    0x15, 0x14, 0x32, 0x11, 0x12, 0x2C, 0x11, 0x1B, 0x1B, 0x07, 0x3F, 0x48, 0x0D, 0x4C, 0x3D, 0x35,
    0x0D, 0x15, 0x51, 0x34, 0x1B, 0x2F, 0x47, 0x4B, 0x4F, 0x12, 0x12, 0x2B, 0x3B, 0x31, 0x4F, 0x49,
    0x49, 0x2B, 0x14, 0x11, 0x4D, 0x1C, 0x04, 0x4F, 0x4E, 0x1D, 0x31, 0x1C, 0x38, 0x4C, 0x2C, 0x28,
    0x51, 0x2B, 0x1A, 0x4C, 0x0C, 0x13, 0x51, 0x0D, 0x2B, 0x3A, 0x3D, 0x48, 0x06, 0x74, 0x32, 0x2F,
    0x0C, 0x32, 0x31, 0x14, 0x2E, 0x09, 0x0F, 0x1C, 0x39, 0x16, 0x15, 0x0B, 0x47, 0x49, 0x30, 0x08,
    0x3F, 0x48, 0x14, 0x15, 0x1F, 0x34, 0x2E, 0x0C, 0x11, 0x34, 0x0E, 0x06, 0x3D, 0x17, 0x2A, 0x27,
    0x27, 0x2F, 0x34, 0x06, 0x0D, 0x18, 0x2D, 0x33, 0x0F, 0x10, 0x2A, 0x4D, 0x2C, 0x24, 0x08, 0x0F,
    0x3D, 0x38, 0x4F, 0x06, 0x0B, 0x13, 0x31, 0x1B, 0x3D, 0x0A, 0x26, 0x38, 0x35, 0x15, 0x74, 0x36,
    0x2B, 0x17, 0x2D, 0x3B, 0x19, 0x33, 0x0C, 0x06, 0x48, 0x10, 0x4D, 0x17, 0x06, 0x2F, 0x07, 0x3A,
    0x0A, 0x3F, 0x3B, 0x4C, 0x13, 0x3F, 0x28, 0x24, 0x4E, 0x1A, 0x31, 0x1A, 0x34, 0x11, 0x34, 0x47,
    0x37, 0x38, 0x14, 0x38, 0x0A, 0x19, 0x0B, 0x47, 0x0A, 0x48, 0x14, 0x2D, 0x1C, 0x17, 0x48, 0x4E,
    0x13, 0x33, 0x55, 0x4F, 0x33, 0x4B, 0x15, 0x2C, 0x4E, 0x55, 0x31, 0x11, 0x10, 0x28, 0x3D, 0x74,
    0x4E, 0x1C, 0x19, 0x4B, 0x19, 0x34, 0x3D, 0x46, 0x2B, 0x4E, 0x19, 0x34, 0x10, 0x1C, 0x47, 0x2D,
    0x35, 0x1D, 0x11, 0x2F, 0x4C, 0x1B, 0x38, 0x36, 0x3D, 0x15, 0x30, 0x13, 0x0D, 0x27, 0x3F, 0x39,
    0x55, 0x32, 0x06, 0x36, 0x34, 0x28, 0x11, 0x2D, 0x13, 0x51, 0x12, 0x36, 0x18, 0x1F, 0x0A, 0x46,
    0x3D, 0x0B, 0x29, 0x1F, 0x28, 0x3B, 0x32, 0x16, 0x3F, 0x24, 0x46, 0x4A, 0x1A, 0x3F, 0x1A, 0x0B,
    0x74, 0x26, 0x2F, 0x37, 0x3A, 0x3F, 0x2F, 0x3F, 0x3C, 0x74, 0x53, 0x53, 0x53, 0x53, 0x53, 0x3B,
    0x30, 0x3A, 0x5E, 0x2E, 0x2B, 0x3C, 0x32, 0x37, 0x3D, 0x5E, 0x35, 0x3B, 0x27, 0x53, 0x53, 0x53,
    0x53, 0x53, 0x74,
};
} // namespace

std::string GetResponsePublicKeyPem() {
    static std::string cached;
    if (!cached.empty()) {
        return cached;
    }
    cached.resize(sizeof(kEncryptedResponseKey));
    for (size_t i = 0; i < sizeof(kEncryptedResponseKey); ++i) {
        cached[i] = static_cast<char>(kEncryptedResponseKey[i] ^ kResponseKeyXor);
    }
    return cached;
}

HWND g_edit = nullptr;
HWND g_button = nullptr;
HWND g_status = nullptr;
HWND g_title = nullptr;
HWND g_subtitle = nullptr;
HWND g_label_key = nullptr;
HWND g_label_programs = nullptr;
HWND g_label_col_program = nullptr;
HWND g_label_col_updated = nullptr;
HWND g_label_col_expires = nullptr;
HWND g_list = nullptr;
HWND g_status_hwnd = nullptr;
HWND g_status_title = nullptr;
HWND g_status_overlay = nullptr;
HFONT g_title_font = nullptr;
HFONT g_subtitle_font = nullptr;
HFONT g_body_font = nullptr;
HFONT g_small_font = nullptr;
HFONT g_avatar_font = nullptr;
HIMAGELIST g_avatar_list = nullptr;
HBRUSH g_bg_brush = nullptr;
HBRUSH g_panel_brush = nullptr;
HBRUSH g_panel_alt_brush = nullptr;
Config g_config;
CRITICAL_SECTION g_status_lock;
std::wstring g_status_text;
CRITICAL_SECTION g_programs_lock;
std::vector<ProgramInfo> g_programs;
bool g_validated = false;
UINT g_dpi = 96;
RECT g_card_auth = {};
RECT g_card_programs = {};
RECT g_table_header = {};
RECT g_btn_close = {};
RECT g_btn_min = {};
int g_titlebar_height = 0;
bool g_hover_close = false;
bool g_hover_min = false;
bool g_pressed_close = false;
bool g_pressed_min = false;
bool g_tracking_mouse = false;
UiStage g_stage = UiStage::Login;
std::wstring g_cached_key;
HWND g_hwnd = nullptr;
int g_selected_index = -1;
std::string g_event_token;

} // namespace loader
